# CodingWorker 詳細設計

## 1. 概要

本ドキュメントはCodingWorker Workerコンポーネントの詳細設計を記述する。

---

## 2. 処理フロー

### 2.1 全体フロー

```
SQSメッセージ受信
       │
       ▼
┌─────────────────────────────────────────────┐
│              processTask                     │
│  ┌─────────────────────────────────────┐    │
│  │ 1. CloneAndBranch                   │    │
│  │    - git clone (最新main)           │    │
│  │    - git checkout -b ai/issue-N     │    │
│  └─────────────────────────────────────┘    │
│                    │                         │
│                    ▼                         │
│  ┌─────────────────────────────────────┐    │
│  │ 2. RunWithTests (2パス実行)         │    │
│  │    - Pass 1: 実装                   │    │
│  │    - Pass 2: テスト作成             │    │
│  └─────────────────────────────────────┘    │
│                    │                         │
│                    ▼                         │
│  ┌─────────────────────────────────────┐    │
│  │ 3. PushAndCreatePR                  │    │
│  │    - git push                       │    │
│  │    - gh pr create                   │    │
│  └─────────────────────────────────────┘    │
└─────────────────────────────────────────────┘
       │
       ▼
SQSメッセージ削除
```

### 2.2 2パス実行 (RunWithTests)

```
Pass 1: 実装
┌────────────────────────────────────────┐
│ Aider実行 (実装プロンプト)             │
└────────────────────────────────────────┘
       │
       ▼
┌────────────────────────────────────────┐
│ ビルド確認 (go build)                  │
│   └─ 失敗 → Aiderに修正依頼 (最大3回) │
└────────────────────────────────────────┘
       │ 成功
       ▼
Pass 2: テスト作成
┌────────────────────────────────────────┐
│ Aider実行 (テスト作成プロンプト)       │
└────────────────────────────────────────┘
       │
       ▼
┌────────────────────────────────────────┐
│ 検証ループ (最大3回)                   │
│   ├─ go build  → 失敗 → Aider修正依頼 │
│   ├─ go fmt    → 自動修正             │
│   ├─ go vet    → 失敗 → Aider修正依頼 │
│   └─ go test   → 失敗 → Aider修正依頼 │
└────────────────────────────────────────┘
       │ 全て成功
       ▼
     完了
```

---

## 3. エラーハンドリング

### 3.1 2レベルリトライ構造

```
外側リトライ (main.go)
│   Policy: config.worker.max_retries
│   Backoff: 固定10秒
│
├── TransientError → リトライ
│   └── Aiderタイムアウト
│
└── PermanentError → 即終了
    └── 内側リトライ全失敗後のエラー

内側リトライ (runner.go)
│   MaxAttempts: 3
│   Backoff: なし
│
└── Aider修正可能なエラー
    ├── ビルドエラー
    ├── Lintエラー
    └── テスト失敗
```

### 3.2 エラー分類

| エラー種別 | 分類 | 処理 |
|:---|:---|:---|
| Aiderタイムアウト | TransientError | 外側リトライ (10秒後) |
| ビルドエラー | 内側リトライ | Aiderに修正依頼 (最大3回) |
| Lintエラー | 内側リトライ | Aiderに修正依頼 (最大3回) |
| テスト失敗 | 内側リトライ | Aiderに修正依頼 (最大3回) |
| 内側リトライ全失敗 | PermanentError | 即終了、Issueにコメント |
| GitHub APIエラー | 自動分類 | ネットワーク系はTransient |

### 3.3 最悪ケースの実行時間

```
外側リトライ: 4回 (初回 + 3リトライ)
内側リトライ: 3回/ステップ
Aiderタイムアウト: 10分

最悪ケース (全タイムアウト):
  4回 × 10分 + 3回 × 10秒 = 約40.5分
```

---

## 4. Aider設定

### 4.1 モデル設定

| 環境 | モデル | タイムアウト | 備考 |
|:---|:---|:---|:---|
| Intel Mac | qwen2.5-coder:1.5b | 600秒 (10分) | CPU推論 |
| Apple Silicon | qwen2.5-coder:7b | 600秒 (10分) | GPU推論 |

**3Bモデル不採用の理由:**
- Diff生成エラー (追加すべきものを削除)
- パス管理の失敗 (`main.go` への短縮)
- 1.5Bより複雑なエラーが発生

### 4.2 Aider設定ファイル

`.aider.conf.yml`:
```yaml
auto-commits: false    # Workerがコミット管理
auto-lint: true        # 自動lint実行
lint-cmd: go fmt ./... # lintコマンド
read:
  - CONVENTIONS.md     # 毎回読み込む規約
```

### 4.3 CONVENTIONS.md

最小限のルール (3項目):
1. 正確なファイルパスを使用
2. エラーハンドリング必須
3. go fmt実行

**最小限にした理由:**
- 1.5Bモデルのコンテキスト圧迫を防ぐ
- 複雑な指示は無視される傾向
- テスト/コメントは作業後チェックで担保

---

## 5. 検証コマンド

| 検証 | コマンド | 失敗時 |
|:---|:---|:---|
| ビルド | `go build ./...` | Aider修正依頼 |
| フォーマット | `go fmt ./...` | 自動修正 |
| 静的解析 | `go vet ./...` | Aider修正依頼 |
| テスト | `go test ./...` | Aider修正依頼 |

---

## 6. 設定項目

### 6.1 config.yaml

```yaml
sqs:
  queue_url: ""
  region: "ap-northeast-1"
  wait_time_seconds: 20
  visibility_timeout: 3600
  use_mock: true

aider:
  bin_path: "${HOME}/.local/bin/aider"
  map_tokens: 0                              # repo-map無効
  models:
    - name: "ollama_chat/qwen2.5-coder:1.5b"
      timeout_seconds: 600

github:
  token: "${GITHUB_TOKEN}"
  clone_base_dir: "/tmp/codingworker"

worker:
  max_retries: 3    # 外側リトライ回数
  worker_id: "mbp-m4-001"
```

### 6.2 デフォルト値

| 項目 | デフォルト値 |
|:---|:---|
| モデル | ollama_chat/qwen2.5-coder:1.5b |
| タイムアウト | 600秒 (10分) |
| 外側リトライ | 3回 |
| 内側リトライ | 3回 |
| リトライ間隔 | 10秒 (固定) |
| map_tokens | 0 (無効) |

---

## 7. 更新履歴

| 日付 | 内容 |
|:---|:---|
| 2025-01-26 | 初版作成: 2パス実行、リトライ構造 |
