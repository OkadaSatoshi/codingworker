# 要求書: CodingWorker - 無料エージェントコーディングシステム

## 1. プロジェクト名

**CodingWorker**

---

## 2. 依頼者情報

- **依頼者**: OkadaSatoshi
- **組織**: 個人プロジェクト
- **作成日**: 2025-01-25

---

## 3. 背景・目的

### 3.1 背景

- 使用頻度が低下したMacBook Pro 2018 (Intel Mac) が手元にある
- LLMベースのコーディングエージェント（OpenHands等）を活用したい
- 商用APIサービス（OpenAI, Anthropic等）の利用コストを抑えたい
- ローカルLLM（Ollama）の実用性を検証したい

### 3.2 目的

MBP 2018 (Intel Mac) を**自律型コーディングワーカー**として再活用し、ランニングコスト（API費用）を**極限まで抑えた**自動開発パイプラインを構築する。

### 3.3 具体的な達成目標

1. **API費用ゼロ**: 外部LLM API（OpenAI, Anthropic等）を一切使用しない
2. **自動化**: GitHub Issues起票から PR作成までの完全自動化
3. **非同期処理**: クラウドとローカルを疎結合に繋ぐアーキテクチャ
4. **IaC管理**: すべてのインフラをコードで管理（Terraform等）
5. **ローカル完結**: 基本的にローカルLLM（Ollama）で処理を完結

---

## 4. システム概要

### 4.1 コア機能

GitHub Issues に起票されたコーディングタスクを、MBP上のローカルLLM（Ollama + qwen2.5-coder:1.5b）で処理し、自動的にコードを生成してPRを作成する。

### 4.2 主要コンポーネント

| コンポーネント | 役割 | 実行環境 |
|:---|:---|:---|
| GitHub Issues | タスク起票 | GitHub |
| GitHub Actions | タスク送信トリガー | GitHub |
| AWS SQS | メッセージキュー | AWS（無料枠） |
| Go Worker | タスク取得・実行制御 | MBP 2018 |
| OpenHands | コーディングエージェント | MBP 2018（Docker） |
| Ollama | ローカルLLM推論 | MBP 2018 |

### 4.3 データフロー

```
1. GitHub Issues にタスク起票
   ↓
2. GitHub Actions が OIDC認証で AWS SQS にメッセージ送信
   ↓
3. MBP上の Go Worker が SQS をロングポーリング
   ↓
4. Worker が Docker API 経由で OpenHands コンテナ起動
   ↓
5. OpenHands がローカル Ollama (qwen2.5-coder:1.5b) を呼び出し
   ↓
6. コード生成後、GitHub へ Push し PR作成
```

---

## 5. 制約条件

### 5.1 コスト制約

- **月額コスト上限**: 2,000円程度（電気代のみ）
- **API利用料**: 0円（外部LLMサービス不使用）
- **AWS無料枠の活用**: SQS 100万リクエスト/月以内

### 5.2 ハードウェア制約

- **実行環境**: MacBook Pro 2018 (Intel Core i7 / 16GB RAM)
- **推論速度**: Intel Macのため低速（10-30秒/応答を想定）
- **同時実行**: 単一ワーカー、同時1タスクのみ

### 5.3 設計制約

- **速度より堅牢性**: リアルタイム性は求めず、バッチ処理として設計
- **IaCファースト**: すべてインフラをコード化（手動設定禁止）
- **非同期アーキテクチャ**: クラウドとローカルを疎結合に接続

---

## 6. 要求事項

### 6.1 機能要求

#### 必須機能（Must Have）

- [x] GitHub Issues からタスクを自動取得
- [x] ローカルLLM（Ollama）でコード生成
- [x] 生成されたコードを自動的にGitHubへCommit
- [x] Pull Request の自動作成
- [x] エラー発生時のログ記録

#### 重要機能（Should Have）

- [ ] Dead Letter Queue（DLQ）によるエラーハンドリング
- [ ] CloudWatch によるモニタリング
- [ ] タイムアウト設定（推奨: 1時間）
- [ ] 自動リトライ機能

#### オプション機能（Could Have）

- [ ] OpenRouter（DeepSeek/Gemini等）へのフォールバック
- [ ] 複数プロジェクトの並行処理
- [ ] Web UI（タスク管理画面）

#### 不要機能（Won't Have）

- ❌ リアルタイムチャット機能
- ❌ GUI による手動操作ツール（Pipedream等）

### 6.2 非機能要求

#### 6.2.1 パフォーマンス

- **応答時間**: 1タスクあたり5分以内（目安）
- **スループット**: 1日あたり10-20タスク処理
- **稼働率**: 80%以上（電源オフ・メンテナンス時を除く）

#### 6.2.2 信頼性

- **データ損失**: SQSメッセージの損失ゼロ
- **リトライ**: 最大3回まで自動リトライ
- **長時間稼働**: 3時間以上の連続稼働に耐える

#### 6.2.3 セキュリティ

- **認証**: IAM OIDC（GitHub ↔ AWS）、IAM User（MBP ↔ AWS）
- **暗号化**: SQSメッセージの暗号化（AWS管理キー）
- **トークン管理**: GitHub Personal Access Token の安全な保管

#### 6.2.4 保守性

- **ログ**: すべての処理をログに記録
- **ドキュメント**: セットアップ手順、トラブルシューティング
- **IaC**: Terraform によるインフラ管理

---

## 7. 期待される成果物

### 7.1 実行可能なシステム

- [ ] ローカル環境（MBP）で動作する完全なシステム
- [ ] GitHub Issues → PR 作成までの自動化フロー
- [ ] エラー発生時の適切なハンドリング

### 7.2 コード・設定ファイル

- [ ] Go Worker のソースコード
- [ ] Terraform 設定ファイル（IaC）
- [ ] GitHub Actions ワークフロー定義
- [ ] OpenHands 設定ファイル
- [ ] Docker Compose 設定

### 7.3 ドキュメント

- [ ] システムアーキテクチャ図
- [ ] セットアップ手順書
- [ ] トラブルシューティングガイド
- [ ] 運用マニュアル
- [ ] API仕様書（SQSメッセージフォーマット等）

---

## 8. リポジトリ構成

### 8.1 Three-Layer IaC 方針

| リポジトリ名 | 役割 | 管理対象 |
|:---|:---|:---|
| **codingworker-infra** | クラウド共通基盤 | IAM OIDC Provider, 共通IAM Role, Terraform State管理 |
| **codingworker-host** | MBP実行環境 | Docker Compose, Go Worker, OpenHands設定 |
| **project-x** | 個別プロジェクト | アプリコード, 専用SQS, GitHub Actions ワークフロー |

### 8.2 各リポジトリの詳細

#### codingworker-infra
- 初期化: 最初に1回のみ
- 更新頻度: 低（ほぼ変更なし）
- 依存関係: なし

#### codingworker-host
- 初期化: MBPセットアップ時
- 更新頻度: 低〜中（ワーカーのアップデート時）
- 依存関係: codingworker-infra

#### project-x
- 初期化: プロジェクトごと
- 更新頻度: 高（開発中は頻繁）
- 依存関係: codingworker-infra, codingworker-host

---

## 9. スケジュール

### 9.1 マイルストーン

| フェーズ | 期間（目安） | 主要成果物 |
|:---|:---|:---|
| Phase 0: ローカル環境 PoC | 3-5日 | Ollama + OpenHands 動作確認 |
| Phase 1: Cloud Foundation | 2-3日 | Terraform, IAM OIDC設定 |
| Phase 2: SQS連携・ワーカー | 3-5日 | Go Worker, GitHub Actions |
| Phase 3: エンドツーエンド統合 | 2-3日 | 全体フロー動作確認 |
| Phase 4: 運用基盤整備 | 2-3日 | モニタリング、ドキュメント |

**合計**: 約12-19日

### 9.2 現在の状況

- **完了**: 要件定義、アーキテクチャ設計
- **進行中**: Phase 0（ローカル環境 PoC）
- **次**: Phase 1（Cloud Foundation構築）

---

## 10. 成功基準

### 10.1 Phase 0（PoC）

- [x] Ollama + qwen2.5-coder:1.5b が MBP で動作する
- [x] OpenHands がローカルLLMを使用してコードを生成できる
- [x] Intel Mac (16GB RAM) で安定動作する

### 10.2 Phase 1-2（基盤構築）

- [ ] GitHub Actions → SQS へのメッセージ送信が成功する
- [ ] Go Worker が SQS からメッセージを取得できる
- [ ] Worker が OpenHands を起動し、コードを生成できる

### 10.3 Phase 3-4（統合・運用）

- [ ] GitHub Issues → PR 作成までの完全自動化が動作する
- [ ] エラー発生時に適切にハンドリングされる
- [ ] 月額コストが2,000円以内に収まる
- [ ] ドキュメントが整備され、第三者が再現可能である

---

## 11. リスクと対策

### 11.1 技術的リスク

| リスク | 影響度 | 対策 |
|:---|:---|:---|
| Intel Mac の推論速度が実用レベルでない | 高 | Phase 0で事前検証、必要に応じてクラウドフォールバック |
| OpenHands と Ollama の連携が不安定 | 中 | 複数のLLMフレームワークを検討 |
| SQS メッセージの損失 | 高 | DLQ の実装、リトライ機能 |

### 11.2 運用リスク

| リスク | 影響度 | 対策 |
|:---|:---|:---|
| MBP の電源断 | 中 | 自動再起動設定、ステータスモニタリング |
| ネットワーク障害 | 中 | ロングポーリング、リトライ機能 |
| ディスク容量不足 | 低 | ログローテーション、定期的なクリーンアップ |

### 11.3 コストリスク

| リスク | 影響度 | 対策 |
|:---|:---|:---|
| AWS 無料枠超過 | 中 | CloudWatch アラート設定、使用量監視 |
| 電気代の増加 | 低 | 消費電力計測、必要に応じて稼働時間調整 |

---

## 12. 将来の拡張予定

### 12.1 短期（3ヶ月以内）

- [ ] 複数プロジェクトの並行処理
- [ ] OpenRouter へのフォールバック機能
- [ ] Web UI（シンプルなタスク管理画面）

### 12.2 中期（6ヶ月以内）

- [ ] Apple Silicon Mac への移行
- [ ] チーム共有機能（複数開発者での利用）
- [ ] より高性能なローカルLLMへの対応

### 12.3 長期（1年以内）

- [ ] SaaSとしての提供
- [ ] マルチテナント対応
- [ ] エンタープライズ向け機能

---

## 13. 承認・合意事項

### 13.1 合意内容

- コストを最優先し、速度は二の次とする
- IaCファーストで、手動設定は一切行わない
- Phase 0 で実用性を検証してから本格構築に進む

### 13.2 承認者

- **依頼者**: OkadaSatoshi
- **実装者**: CodingWorker プロジェクトチーム（Claude Code, Claude等）

---

## 14. 補足事項

### 14.1 参照ドキュメント

- `プロジェクト概要.md`: システムアーキテクチャ、技術スタック
- `CodingWorker_要件定義.md`: 詳細な機能・非機能要件
- `CodingWorker_タスク一覧.md`: 全フェーズのタスク詳細

### 14.2 連絡先

- GitHub: https://github.com/OkadaSatoshi
- Project Board: https://github.com/users/OkadaSatoshi/projects/1

---

**承認日**: 2025-01-25  
**バージョン**: 1.0
